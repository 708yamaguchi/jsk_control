#!/usr/bin/env roseus

(load "package://eus_qp/optmotiongen/euslisp/sample/sample-inverse-kinematics.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-inverse-kinematics-statics.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-sqp-optimization-instant.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-sqp-optimization-instant-manip.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-sqp-optimization-trajectory.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-sqp-optimization-trajectory-manip.l")
(load "package://eus_qp/optmotiongen/euslisp/sample/sample-sqp-optimization-bspline.l")

(defun generate-gif-all
    ()
  (format t "~%~%## Sample (irteus sample robot)~%~%")
  (format t "Gif images are generated by [generate-gif.l](doc/generate-gif.l). Gif animation is not realtime (actually it is slower than gif animation).~%~%")

  (format t "### inverse-kinematics-optmotiongen~%~%")
  (format t "[sample-inverse-kinematics.l](./euslisp/sample/sample-inverse-kinematics.l)~%~%")
  (generate-gif
   :func-name-list
   (list "sample-arm-reach-ik-raw"
         "sample-arm-reach-ik"
         "sample-arm-reach-ik-obstacle"
         "sample-arm-reach-ik-posture"
         "sample-arm-reach-ik-with-root-virtual-joint"
         "sample-arm-reach-ik-face"
         "sample-arm-reach-ik-line"
         "sample-robot-reach-ik"
         "sample-robot-reach-ik-limb"
         "sample-robot-reach-ik-dual-arm"
         "sample-robot-reach-ik-dual-arm-with-torso"
         "sample-robot-reach-ik-fullbody"
         ))

  (format t "### inverse-kinematics-trajectory-optmotiongen~%~%")
  (format t "[sample-inverse-kinematics.l](./euslisp/sample/sample-inverse-kinematics.l)~%~%")
  (generate-gif
   :func-name-list
   (list "sample-arm-reach-trajectory-ik-raw"
         "sample-arm-reach-trajectory-ik"
         "sample-arm-reach-trajectory-ik-with-root-virtual-joint"
         "sample-arm-reach-trajectory-ik-with-root-virtual-joint-obstacle"
         "sample-robot-reach-trajectory-ik-dual-arm-with-torso"
         "sample-robot-reach-trajectory-ik-dual-arm-with-torso-no-mid-constraint"
         "sample-robot-reach-trajectory-ik-fullbody"
         ))

  (format t "### inverse-kinematics-statics-optmotiongen~%~%")
  (format t "[sample-inverse-kinematics-statics.l](./euslisp/sample/sample-inverse-kinematics-statics.l)~%~%")
  (generate-gif
   :func-name-list
   (list "sample-robot-reach-iks-raw"
         (list "sample-robot-reach-iks :optimize-torque? nil" "sample-robot-reach-iks-without-torque")
         (list "sample-robot-reach-iks :optimize-torque? t" "sample-robot-reach-iks")
         (list "sample-robot-reach-iks-face :optimize-torque? nil" "sample-robot-reach-iks-face-without-torque")
         (list "sample-robot-reach-iks-face :optimize-torque? t" "sample-robot-reach-iks-face")
         ))

  (format t "### inverse-kinematics-statics-trajectory-optmotiongen~%~%")
  (format t "[sample-inverse-kinematics-statics.l](./euslisp/sample/sample-inverse-kinematics-statics.l)~%~%")
  (generate-gif
   :func-name-list
   (list "sample-robot-reach-trajectory-iks-raw"
         (list "sample-robot-reach-trajectory-iks :optimize-start-end-torque? nil" "sample-robot-reach-trajectory-iks-without-torque")
         (list "sample-robot-reach-trajectory-iks :optimize-start-end-torque? t" "sample-robot-reach-trajectory-iks")
         (list "sample-robot-reach-trajectory-iks-face :optimize-start-end-torque? nil" "sample-robot-reach-trajectory-iks-face-without-torque")
         (list "sample-robot-reach-trajectory-iks-face :optimize-start-end-torque? t" "sample-robot-reach-trajectory-iks-face")
         ))

  (format t "~%~%## Sample (HRP2)~%~%")

  (format t "### instant-configuration-task~%~%")
  (format t "[sample-sqp-optimization-instant.l](./euslisp/sample/sample-sqp-optimization-instant.l)~%~%")
  (generate-gif
   :func-name-list
   (list (list "sample-sqp-optimization-instant :optimize-torque? t" "sample-sqp-optimization-instant")
         (list "sample-sqp-optimization-instant :optimize-torque? nil" "sample-sqp-optimization-instant-without-torque")
         (list "sample-sqp-optimization-instant :only-kinematics? t" "sample-sqp-optimization-instant-only-kinematics")
         ))

  (format t "### trajectory-configuration-task~%~%")
  (format t "[sample-sqp-optimization-trajectory.l](./euslisp/sample/sample-sqp-optimization-trajectory.l)~%~%")
  (generate-gif
   :func-name-list
   (list (list "sample-sqp-optimization-trajectory :optimize-start-end-torque? t" "sample-sqp-optimization-trajectory")
         (list "sample-sqp-optimization-trajectory :optimize-start-end-torque? nil" "sample-sqp-optimization-trajectory-without-torque")
         ))

  (format t "### instant-manip-configuration-task~%~%")
  (format t "[sample-sqp-optimization-instant-manip.l](./euslisp/sample/sample-sqp-optimization-instant-manip.l)~%~%")
  (generate-gif
   :func-name-list
   (list (list "sample-sqp-optimization-instant-manip :optimize-torque? t" "sample-sqp-optimization-instant-manip")
         (list "sample-sqp-optimization-instant-manip :optimize-torque? nil" "sample-sqp-optimization-instant-manip-without-torque")
         ))

  (format t "### trajectory-manip-configuration-task~%~%")
  (format t "[sample-sqp-optimization-trajectory-manip.l](./euslisp/sample/sample-sqp-optimization-trajectory-manip.l)~%~%")
  (generate-gif
   :func-name-list
   (list (list "sample-sqp-optimization-trajectory-manip :optimize-start-end-torque? t" "sample-sqp-optimization-trajectory-manip")
         (list "sample-sqp-optimization-trajectory-manip :optimize-start-end-torque? nil" "sample-sqp-optimization-trajectory-manip-without-torque")
         ))

  (format t "### bspline-configuration-task~%~%")
  (format t "[sample-sqp-optimization-bspline.l](./euslisp/sample/sample-sqp-optimization-bspline.l)~%~%")
  (format t "[graph of joint trajectory](./logs/sample-sqp-optimization-bspline.pdf)~%")
  (generate-gif
   :func-name-list
   (list "sample-sqp-optimization-bspline"
         ))
  )
(warn "(generate-gif-all)~%")

(defun generate-gif
    (&key
     (func-name-list)
     )
  (dolist (func-name func-name-list)
    (null-output
     (setq *gif-name* (if (consp func-name) (elt func-name 1) func-name))
     (eval (read-from-string
            (format nil "
(~a
 :pre-process-func
 #'(lambda (sqp)
     (when (= (send sqp :iteration) 1)
       (setup-gif-animation))
     (save-image-for-gif-animation)
     )
 :visualize-callback-func
 #'save-image-for-gif-animation
 :visualize-loop? nil
 :output-filename nil
 )
" (if (consp func-name) (elt func-name 0) func-name))))
     (create-gif-animation :save-dir (ros::resolve-ros-path "package://eus_qp/optmotiongen/doc/images"))
    )
   (format t "###### ~a~%" *gif-name*)
   (format t "```~%(~a)~%```~%" (if (consp func-name) (elt func-name 0) func-name))
   (format t "![~a](doc/images/~a.gif)~%~%" *gif-name* *gif-name*)
   )
  )

(defun setup-gif-animation
    (&key
     (name *gif-name*)
     (look-all? t)
     (manual-adjust? nil)
     )
  (setq *gif-image-idx* 10000)
  (send *irtviewer* :resize 600 600)
  (when look-all?
    (send *irtviewer* :look-all))
  (send *irtviewer* :draw-objects)
  (when manual-adjust?
    (warning-message 1 "[gif] press Key if ready to start~%")
    (while t
      (x::window-main-one)
      (unix:usleep (* 100 1000))
      (when (kbhit)
        (return-from nil nil))
      )
    )
  (unix:system (format nil "rm -rf /tmp/eus_qp/optmotiongen/~a" name))
  (unix:system (format nil "mkdir -p /tmp/eus_qp/optmotiongen/~a/figs" name))
  (unix:usleep (* 100 1000))
  )

(defun save-image-for-gif-animation
    (&key
     (name *gif-name*)
     )
  (send *irtviewer* :viewer :viewsurface :write-to-image-file
        (format nil "/tmp/eus_qp/optmotiongen/~a/figs/~a.png" name *gif-image-idx*))
  (incf *gif-image-idx*)
  )

(defun create-gif-animation
    (&key
     (name *gif-name*)
     (save-dir "/tmp")
     )
  (let* ((gif-path
          (format nil "~a/~a.gif" save-dir name))
         )
    (warning-message 1 "[gif] saving gif animation file to ~a~%" gif-path)
    (unix:system
     (format nil "convert -delay 6 -loop 0 -fuzz 5% -layers Optimize /tmp/eus_qp/optmotiongen/~a/figs/*.png ~a" name gif-path))
    ))


(generate-gif-all)
(exit 0)
